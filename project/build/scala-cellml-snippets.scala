import sbt._
import Process._
import java.lang.{ProcessBuilder => PB}
import java.io.File

class ScalaCellmlSnippets(info: ProjectInfo) extends DefaultProject(info)
{
  //def extraResources = "LICENSE" +++ "COPYING" +++ "README.md"
  //override def mainResources = super.mainResources +++ extraResources
  
  val scalaSwing = "org.scala-lang" % "scala-swing" % "2.8.0"

  override def packageOptions: Seq[PackageOption] = MainClass("fixer") :: Nil
  override def mainScalaSourcePath = "src"

  lazy val literatedocs = task {
    val p = path("src")
    val f = p * "*.scala"
    val files = f.get.map(_.asFile.getName())
    val command = Seq("rocco", "-o", "../../../../../../docs", "-l", "scala", "-c", "//") ++ files.toSeq 
    (new PB(command : _*) directory p.asFile) ! ;
    None
  }
  // For the moment, we embed the reponame, temporary directories, etc
  private val repoName = "git@github.com:flaviusb/cellml-snippets.git"
  private val repoDir  = "cellml-snippets-gh-pages"
  private val mainDoc  = "constantconverter.html"
  lazy val initialize_gh_pages = task {
    FileUtilities.doInTemporaryDirectory(new ConsoleLogger())((tmp: File) => {
      (new PB("git", "clone", repoName, repoDir) directory tmp) ! ;
      val tmprep = new File(tmp, repoDir)
      (new PB("git", "symbolic-ref", "HEAD", "refs/heads/gh-pages") directory tmprep) ! ;
      (new PB("rm", ".git/index") directory tmprep) ! ;
      (new PB("git", "clean", "-fdx") directory tmprep) ! ;
      val docs: PathFinder = "docs" ** "*.html"
      docs.get.foreach(a => a.asFile #> new File(tmprep, a.asFile.getName()))
      ("docs" / mainDoc).asFile #> new File(tmprep, "index.html")
      (new PB("git", "add", ".") directory tmprep) ! ;
      (new PB("git", "commit", "-a", "-m", "First commit of autogenerated docs") directory tmprep) ! ;
      (new PB("git", "push", "origin", "gh-pages") directory tmprep) ! ;
      Left("Done")
    })
    None
  } dependsOn(literatedocs)
  lazy val update_gh_pages = task {
    FileUtilities.doInTemporaryDirectory(new ConsoleLogger())((tmp: File) => {
      (new PB("git", "clone", repoName, repoDir) directory tmp) ! ;
      val tmprep = new File(tmp, repoDir)
      (new PB("git", "checkout", "-f", "gh-pages") directory tmprep) ! ;
      (new PB("rm", "-rf", "*") directory tmprep) ! ;
      val docs: PathFinder = path("docs") * "*.html"
      docs.get.foreach(a => { 
        println("Copying: " + a.toString + " to " + new File(tmprep, a.asFile.getName()))
        a.asFile #> new File(tmprep, a.asFile.getName()) !
      })
      ("docs" / mainDoc).asFile #> new File(tmprep, "index.html") ! ;
      (new PB("git", "add", "--all", ".") directory tmprep) ! ;
      (new PB("git", "commit", "-a", "-m", "Automatically generated commit from sbt update_gh_pages.") directory tmprep) ! ;
      (new PB("git", "push", "origin", "gh-pages") directory tmprep) ! ;
      Left("Done")
    })
    None
  } dependsOn(literatedocs)
}
